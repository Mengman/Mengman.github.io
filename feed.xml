<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.1.1">Jekyll</generator><link href="https://mengman.github.io/feed.xml" rel="self" type="application/atom+xml" /><link href="https://mengman.github.io/" rel="alternate" type="text/html" /><updated>2021-06-14T01:44:21+08:00</updated><id>https://mengman.github.io/feed.xml</id><title type="html">Mengman的异想世界</title><subtitle>Program 4 Fun/n Program 4 Life</subtitle><entry><title type="html">机器学习项目基础设施</title><link href="https://mengman.github.io/matchinelearning/deeplearning/softwareenginer/2021/06/14/machine-learning-infrastructures.html" rel="alternate" type="text/html" title="机器学习项目基础设施" /><published>2021-06-14T00:00:00+08:00</published><updated>2021-06-14T00:00:00+08:00</updated><id>https://mengman.github.io/matchinelearning/deeplearning/softwareenginer/2021/06/14/machine-learning-infrastructures</id><content type="html" xml:base="https://mengman.github.io/matchinelearning/deeplearning/softwareenginer/2021/06/14/machine-learning-infrastructures.html">&lt;h1 id=&quot;机器学习项目基础设施&quot;&gt;机器学习项目基础设施&lt;/h1&gt;

&lt;p&gt;机器学习过程可以大体上分为三个部分数据管理、模型训练与生产部署。&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/ml_infrastructure.png&quot; alt=&quot;ml_infrastructure&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;em&gt;图片来自课程 &lt;a href=&quot;[Lecture 6: Infrastructure &amp;amp; Tooling - Full Stack Deep Learning](https://fullstackdeeplearning.com/spring2021/lecture-6/)&quot;&gt;Full Stack Deep Learning&lt;/a&gt;&lt;/em&gt;&lt;/p&gt;

&lt;h2 id=&quot;数据管理&quot;&gt;数据管理&lt;/h2&gt;

&lt;h3 id=&quot;数据源sources&quot;&gt;数据源(sources)&lt;/h3&gt;

&lt;p&gt;数据源负责数据的存储与数据格式，常用的存储方式包括本地的文件系统、服务器上的对象存储。常用的数据格式有HDF5、Parquet 等。&lt;/p&gt;

&lt;h3 id=&quot;数据湖数据仓库&quot;&gt;数据湖/数据仓库&lt;/h3&gt;

&lt;p&gt;负责管理记录数据集，常见的数据湖软件/服务包括有：snowflake、databricks&lt;/p&gt;

&lt;h3 id=&quot;数据处理&quot;&gt;数据处理&lt;/h3&gt;

&lt;p&gt;数据处理有很多并行计算的框架&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;apache airflow：由 Airbnb 开源的计算框架，可以用来构建 DAG 计算图，实现数据的细粒度并行处理。&lt;/li&gt;
  &lt;li&gt;spark：老牌数据流处理框架，支持 Java、Python 在内的多种语言。&lt;/li&gt;
  &lt;li&gt;Dagster：和 airflow 一样也是一个数据计算的编排框架&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;数据分析&quot;&gt;数据分析&lt;/h3&gt;

&lt;ul&gt;
  &lt;li&gt;pandas：最常用的数据处理框架&lt;/li&gt;
  &lt;li&gt;rapis: 基本上就是支持 GPU 计算的pandas&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;版本控制&quot;&gt;版本控制&lt;/h3&gt;

&lt;ul&gt;
  &lt;li&gt;DVC：全名叫 Data version control，专门负责数据版本控制还有模型版本控制的工具，它的操作基于git，通过对大文件的管理来实现版本控制。&lt;/li&gt;
  &lt;li&gt;Pachyderm:  Pachyderm 不只是单纯的数据版本控制，还提供了数据生成pipeline的管理。&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;模型训练&quot;&gt;模型训练&lt;/h2&gt;

&lt;h3 id=&quot;计算设备服务&quot;&gt;计算设备&amp;amp;服务&lt;/h3&gt;

&lt;p&gt;本地的计算设备、各种云计算服务&lt;/p&gt;

&lt;h3 id=&quot;资源管理&quot;&gt;资源管理&lt;/h3&gt;

&lt;p&gt;Docke、sdetermined AI 等&lt;/p&gt;

&lt;h3 id=&quot;计算框架分布式训练框架&quot;&gt;计算框架&amp;amp;分布式训练框架&lt;/h3&gt;

&lt;p&gt;深度学习框架：Pytorch、 tensorflow&lt;/p&gt;

&lt;p&gt;深度学习库：&lt;a href=&quot;http://fast.ai&quot;&gt;fast.ai&lt;/a&gt;、keras&lt;/p&gt;

&lt;p&gt;分布式计算框架：RAY 等&lt;/p&gt;

&lt;h3 id=&quot;实验管理&quot;&gt;实验管理&lt;/h3&gt;

&lt;ul&gt;
  &lt;li&gt;TensorBoard：tensorflow 的可视化实验管理模块，现在独立出来，甚至 pytorch 都对他进行了支持。但是它没有对多个实验的管理能力。&lt;/li&gt;
  &lt;li&gt;mlflow：是一款开源的试验管理工具，最大的特点是提供本地的实验管理功能，没有各种收费的云服务版本。&lt;/li&gt;
  &lt;li&gt;weights &amp;amp; biases: 是一款综合的实验管理工具，它除了提供实验追踪，还提供了数据可视化、模型调优等功能。但是 W&amp;amp;B 是一款基于网络服务的实验管理工具。&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;http://Neptune.ai&quot;&gt;Neptune.ai&lt;/a&gt; &lt;a href=&quot;http://comet.ml&quot;&gt;comet.ml&lt;/a&gt;:  也是基于网络服务的实验管理工具。&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;超参调试&quot;&gt;超参调试&lt;/h3&gt;

&lt;ul&gt;
  &lt;li&gt;SIGOPT&lt;/li&gt;
  &lt;li&gt;Determined AI&lt;/li&gt;
  &lt;li&gt;Weight &amp;amp; Biases&lt;/li&gt;
  &lt;li&gt;Tune&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;模型部署&quot;&gt;模型部署&lt;/h2&gt;

&lt;h3 id=&quot;ci测试&quot;&gt;CI&amp;amp;测试&lt;/h3&gt;

&lt;ul&gt;
  &lt;li&gt;Jenkins&lt;/li&gt;
  &lt;li&gt;Gitlab CI&lt;/li&gt;
  &lt;li&gt;Circle CI&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;边缘设备部署&quot;&gt;边缘设备部署&lt;/h3&gt;

&lt;ul&gt;
  &lt;li&gt;Nvidia TensorRT&lt;/li&gt;
  &lt;li&gt;TensorFlow Lite&lt;/li&gt;
&lt;/ul&gt;</content><author><name></name></author><category term="matchinelearning" /><category term="deeplearning" /><category term="softwareenginer" /><summary type="html">机器学习项目基础设施 机器学习过程可以大体上分为三个部分数据管理、模型训练与生产部署。 图片来自课程 Full Stack Deep Learning 数据管理 数据源(sources) 数据源负责数据的存储与数据格式，常用的存储方式包括本地的文件系统、服务器上的对象存储。常用的数据格式有HDF5、Parquet 等。 数据湖/数据仓库 负责管理记录数据集，常见的数据湖软件/服务包括有：snowflake、databricks 数据处理 数据处理有很多并行计算的框架 apache airflow：由 Airbnb 开源的计算框架，可以用来构建 DAG 计算图，实现数据的细粒度并行处理。 spark：老牌数据流处理框架，支持 Java、Python 在内的多种语言。 Dagster：和 airflow 一样也是一个数据计算的编排框架 数据分析 pandas：最常用的数据处理框架 rapis: 基本上就是支持 GPU 计算的pandas 版本控制 DVC：全名叫 Data version control，专门负责数据版本控制还有模型版本控制的工具，它的操作基于git，通过对大文件的管理来实现版本控制。 Pachyderm: Pachyderm 不只是单纯的数据版本控制，还提供了数据生成pipeline的管理。 模型训练 计算设备&amp;amp;服务 本地的计算设备、各种云计算服务 资源管理 Docke、sdetermined AI 等 计算框架&amp;amp;分布式训练框架 深度学习框架：Pytorch、 tensorflow 深度学习库：fast.ai、keras 分布式计算框架：RAY 等 实验管理 TensorBoard：tensorflow 的可视化实验管理模块，现在独立出来，甚至 pytorch 都对他进行了支持。但是它没有对多个实验的管理能力。 mlflow：是一款开源的试验管理工具，最大的特点是提供本地的实验管理功能，没有各种收费的云服务版本。 weights &amp;amp; biases: 是一款综合的实验管理工具，它除了提供实验追踪，还提供了数据可视化、模型调优等功能。但是 W&amp;amp;B 是一款基于网络服务的实验管理工具。 Neptune.ai comet.ml: 也是基于网络服务的实验管理工具。 超参调试 SIGOPT Determined AI Weight &amp;amp; Biases Tune 模型部署 CI&amp;amp;测试 Jenkins Gitlab CI Circle CI 边缘设备部署 Nvidia TensorRT TensorFlow Lite</summary></entry><entry><title type="html">机器学习中的交叉熵</title><link href="https://mengman.github.io/machinelearning/math/2020/09/27/cross-entropy.html" rel="alternate" type="text/html" title="机器学习中的交叉熵" /><published>2020-09-27T14:11:00+08:00</published><updated>2020-09-27T14:11:00+08:00</updated><id>https://mengman.github.io/machinelearning/math/2020/09/27/cross-entropy</id><content type="html" xml:base="https://mengman.github.io/machinelearning/math/2020/09/27/cross-entropy.html">&lt;h1 id=&quot;机器学习中的交叉熵&quot;&gt;机器学习中的交叉熵&lt;/h1&gt;

&lt;p&gt;交叉熵损失函数是机器学习分类问题中最常用的一个损失函数。但是很多人对于“交叉熵”的概念缺乏理解。本文的目的是希望能够通俗易懂的解释清楚 “熵”， “交叉熵” 和 “KL-散度” 这三个相关的概念。&lt;/p&gt;

&lt;h2 id=&quot;信息论中的熵&quot;&gt;信息论中的“熵”&lt;/h2&gt;

&lt;p&gt;“熵” (entropy) 这个概念在热力学中表示一个系统的无序程度，熵越大系统就越混乱。1948年香农在其发表的《通信的数学理论》论文中给出了”信息熵“的定义：信息熵是随机事件不确定性的度量。信息熵与热力学熵有着紧密的内在联系，不过在本文中所讨论的熵都是指信息熵。&lt;/p&gt;

&lt;h3 id=&quot;有效信息长度&quot;&gt;有效信息长度&lt;/h3&gt;

&lt;p&gt;为了能更好的解释信息熵，我们先来看一个例子。有一个气象监测站，通过检测某地的气象数据，能给出第二天的天气预测。气象站需要将预测结果网络发送给气象中心。如果当地只有两种天气一种是晴天，一种是雨天，那么气象站如何能够高效的发送预测结果呢？最简单的情况下，气象站可以将预测结果以汉字的形式发送出去。如果预测是晴天就发送”晴天“，如果是雨天就发送”雨天“。我们知道一个汉字在计算机中通常的编码长度是 2 byte，也就是 8 bit，那么这两个汉字就是 16 bit。为了能更高效的发送信息，我们可以对信息进行编码，用 0 来表示晴天，1 来表示雨天。那么我们需要发送的信息长度就只有 1 bit 了。对于原来长度为 16 bit 的信息来说，它&lt;strong&gt;真正有效的信息长度&lt;/strong&gt;其实只有 1 bit。&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/entropy1.png&quot; alt=&quot;weather_2&quot; /&gt;&lt;/p&gt;

&lt;p&gt;那如果当地天气有8种情况，我们需要多少长度的消息才能发送预测结果呢？答案很简单：\(2^3=8\) ，我们只需要3个 bit 就能发送8种天气。在计算机中对于任意n种分类情况，我们只需要 \(log_2 (n)\) 长度的编码信息就可以把所有的情况进行编码。&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/entropy2.png&quot; alt=&quot;c&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;信息熵&quot;&gt;信息熵&lt;/h3&gt;

&lt;p&gt;我们知道在现实中，第二天出现什么天气的概率不是均等的，在夏天出现晴天和雨天的概率比较大，而出现雪天的概率很小；而在冬天出现雨天的概率较小，出现雪天的概率较大。在第一个例子中如果晴天的概率是 75%， 雨天的概率是 25%，那么消息的长度应该是多少呢？在计算消息长度之前，我们需要先介绍“熵减因子”(reduction factor)的概念。按照香农在论文中提出：&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;每发送1个bit的有效信息，能减少了接收者2个因子的不确定性。&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;strong&gt;熵减因子&lt;/strong&gt; m 与有&lt;strong&gt;效消息长度&lt;/strong&gt; u 之间的关系是： \(2^u=m\)&lt;/p&gt;

&lt;p&gt;在已知事件概率的情况下，熵减因子 m 与概率 p 的关系是： \(\frac{1}{p}=m\)&lt;/p&gt;

&lt;p&gt;基于熵减因子与概率的关系，我们可以根据概率 p 推断出有效信息的长度 u 的关系:  \(-log_2{p} = u\)&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/entropy4.png&quot; alt=&quot;wheather_4&quot; /&gt;&lt;/p&gt;

&lt;p&gt;现在我们可以回答之前提出的问题了。&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;晴天的有效信息长度&lt;/strong&gt;  \(m_s = -log_2{p_s} = -log_2{0.75} = 0.41\)&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;雨天的有效信息长度&lt;/strong&gt; \(m_r = -log_2{p_r} = -log_2{0.25} = 2\)&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;平均有效信息长度&lt;/strong&gt; \(m_{avg} = p_s * (-log_2{p_s}) + p_r * (-log_2{p_r}) = 0.75 * 0.41 + 0.25 * 2 = 0.81\)&lt;/p&gt;

&lt;p&gt;平均有效信息长度又被称为&lt;strong&gt;信息熵&lt;/strong&gt; , 数学定义为：&lt;/p&gt;

\[\text{Entropy},H(p) = - \sum{p(i)*log(p(i))}\]

&lt;p&gt;我们按照现实情况，分别给第二个例子中8种天气加一个概率。&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/entropy3.png&quot; alt=&quot;weather_8_prob&quot; /&gt;&lt;/p&gt;

&lt;p&gt;按照信息熵的定义，我们可以计算出此时的信息熵：&lt;/p&gt;

\[\begin{aligned} 
\text{Entropy} &amp;amp; = -0.35 * log_2{0.35} -0.35 * log_2{0.35} \\
 &amp;amp; -0.10 * log_2{0.10} -0.10 * log_2{0.10} \\
 &amp;amp; -0.04 * log_2{0.04} -0.04 * log_2{0.04} \\
 &amp;amp; -0.01 * log_2{0.01} -0.01 * log_2{0.01} \\
 &amp;amp; = 2.23
\end{aligned}\]

&lt;p&gt;&lt;strong&gt;信息熵是理论上最小的平均消息长度&lt;/strong&gt;。&lt;/p&gt;

&lt;h3 id=&quot;交叉熵&quot;&gt;交叉熵&lt;/h3&gt;

&lt;p&gt;通过信息熵公式我们可以计算出，理论上发送信息的最小平均长度是 2.23，上图因为多所有天气都按照3位进行编码，所以消息的平均长度是3。通过修改信息的编码方式，我们可以降低消息的平均长度。&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/entropy5.png&quot; alt=&quot;weather_9_prob&quot; /&gt;&lt;/p&gt;

&lt;p&gt;通过减小高概率天气的消息长度，增长低概率天气的消息长度，我们可以降低平均的消息长度。
\(0.35 * 2 + 0.35 * 2 + 0.1 * 3+ 0.1 * 3 + 0.04 * 4 + 0.04 * 4  + 0.01 * 4 + 0.01 * 5 = 2.42\)
&lt;img src=&quot;/assets/entropy6.png&quot; alt=&quot;weather_10_prob&quot; /&gt;&lt;/p&gt;

&lt;p&gt;如果我们反过来增长低概率天气的消息长度，减小大概率天气的长度，那么消息的平均长度增大。
\(0.01 * 2 + 0.01 * 2 + 0.04 * 3 + 0.04 * 3 + 0.1 * 4 + 0.1 * 4 + 0.35 * 5 + 0.35 * 5 = 4.58\)&lt;/p&gt;

&lt;p&gt;上面两个例子中，我们计算信息平均长度时，是用真实的天气概率乘以我们&lt;strong&gt;给定的有效信息长度&lt;/strong&gt;， 上面计算结果叫做&lt;strong&gt;交叉熵&lt;/strong&gt;。&lt;/p&gt;

&lt;p&gt;在已知各种情况天气的概率下，可以通过信息熵的公式计算出理论上最小的平均信息长度。但是在现实生活中，我们经常是不知道各种情况的实际概率分布的。在这种情况下，我们可以预先给出一个对于真实概率分布的一个估计（在上面的例子是预先给出一个信息长度）。
&lt;img src=&quot;/assets/entropy7.png&quot; alt=&quot;weather_11_prob&quot; /&gt;&lt;/p&gt;

&lt;p&gt;图中红色的概率代表天气的真实分布，而蓝色概率代表按照编码长度推算出来的对于天气概率的估计。真实的概率分布于估计概率分布之间的关系可以用&lt;strong&gt;交叉熵&lt;/strong&gt;的形式表达出来。&lt;/p&gt;

\[\text{CrossEntropy,}H(p,q) = - \sum{p(i)log(q(i))}\]

&lt;p&gt;通过前面的内容我们可以知道，只有&lt;strong&gt;估计概率越接近于真正的概率，交叉熵才会越小，当估计概率等于真实概率时，交叉熵等于信息熵。&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;交叉熵公式于信息熵公式的不同之处在于，将 log 部分的概率分布替换成了&lt;strong&gt;预测概率分布&lt;/strong&gt;。&lt;strong&gt;交叉熵大于信息熵的部分叫做Kullback-Leibler Divergence（KL散度）也叫相对熵（Relative Entropy）&lt;/strong&gt;。&lt;/p&gt;

\[\begin{aligned}
\text{KL-Divergence} &amp;amp;= \text{Entropy} - \text{CrossEntropy}  \\
D_{KL}(p||q) &amp;amp; = H(p,q) - H(p) \\
&amp;amp; = -\sum_i{p_ilog(q_i)} - (-\sum_i{p_ilog(p_i)}) \\
&amp;amp; = -\sum_i{p_ilog(q_i)} + \sum_i{p_ilog(p_i)} \\
&amp;amp; = \sum_i{p_i log(\frac{p_i}{q_i})}
\end{aligned}\]

&lt;h2 id=&quot;交叉熵在机器学习中的应用&quot;&gt;交叉熵在机器学习中的应用&lt;/h2&gt;

&lt;p&gt;由于交叉熵的性质，所以在机器学习中，交叉熵被广泛的作为&lt;strong&gt;分类损失函数&lt;/strong&gt;。&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/ce_loss.png&quot; alt=&quot;ce_loss&quot; /&gt;&lt;/p&gt;

&lt;p&gt;在一个分类任务的训练过程中，我们已知目标的真实概率分布，分类器在每次的训练过程中会给出一个预测的概率分布。我们把&lt;strong&gt;交叉熵&lt;/strong&gt;作为我们的目标函数，优化的方向是使得目标函数（交叉熵）最小，交叉熵只有在预测概率分布于真实概率分布一致的情况下最小，所以交叉熵非常适合作为分类任务的损失函数。&lt;/p&gt;

&lt;p&gt;在信息论中&lt;strong&gt;信息熵&lt;/strong&gt;，&lt;strong&gt;交叉熵&lt;/strong&gt;公式中的 log 都是以 2 为底的对数，但是在机器学习中代码实现中，无论是用以10为底或者e为底都无所谓，因为对数都可以通过换底公式进行变换： \(log_e{n} = \frac{log_2{n}}{log_2{e}}\) ，因为分母始终是一个常数所以对于损失函数没有影响。&lt;/p&gt;

&lt;p&gt;信息熵原本作为信息论的一个重要概念，没有想到在多年以后会在机器学习中继续大放异彩。希望通过本文的内容能理解&lt;strong&gt;交叉熵损失函数&lt;/strong&gt;真正的意义。本文是根据文章 &lt;a href=&quot;https://towardsdatascience.com/entropy-cross-entropy-and-kl-divergence-explained-b09cdae917a&quot;&gt;Entropy, Cross-Entropy, and KL-Divergence Explained!&lt;/a&gt; 进行的改写，读者可以阅读原文获得跟多关于交叉熵的认识。&lt;/p&gt;</content><author><name></name></author><category term="machinelearning" /><category term="math" /><summary type="html">机器学习中的交叉熵</summary></entry><entry><title type="html">pkg-config 入门</title><link href="https://mengman.github.io/c++/linux/2020/07/26/pkg-config-introduction.html" rel="alternate" type="text/html" title="pkg-config 入门" /><published>2020-07-26T00:41:00+08:00</published><updated>2020-07-26T00:41:00+08:00</updated><id>https://mengman.github.io/c++/linux/2020/07/26/pkg-config-introduction</id><content type="html" xml:base="https://mengman.github.io/c++/linux/2020/07/26/pkg-config-introduction.html">&lt;h1 id=&quot;pkg-config-入门&quot;&gt;pkg-config 入门&lt;/h1&gt;

&lt;p&gt;pkg-config 是类 Unix 操作系统上的一个库查询工具。它通过 .pc 文件来查询当前系统上已安装类库的信息。&lt;/p&gt;

&lt;p&gt;下面是 OpenCV4 的 pc 文件， 文件中包含了OpenCV 库的很多元数据(metadata)&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;# Package Information for pkg-config

prefix=/usr/local/opencv4
exec_prefix=${prefix}
libdir=${exec_prefix}/lib
includedir_old=${prefix}/include/opencv4/opencv
includedir_new=${prefix}/include/opencv4

Name: OpenCV
Description: Open Source Computer Vision Library
Version: 4.0.1
Libs: -L${exec_prefix}/lib -lopencv_gapi -lopencv_stitching -lopencv_aruco -lopencv_bgsegm -lopencv_bioinspired -lopencv_ccalib -lopencv_cvv -lopencv_dnn_objdetect -lopencv_dpm -lopencv_face -lopencv_freetype -lopencv_fuzzy -lopencv_hdf -lopencv_hfs -lopencv_img_hash -lopencv_line_descriptor -lopencv_reg -lopencv_rgbd -lopencv_saliency -lopencv_sfm -lopencv_stereo -lopencv_structured_light -lopencv_phase_unwrapping -lopencv_superres -lopencv_optflow -lopencv_surface_matching -lopencv_tracking -lopencv_datasets -lopencv_text -lopencv_dnn -lopencv_plot -lopencv_videostab -lopencv_video -lopencv_xfeatures2d -lopencv_shape -lopencv_ml -lopencv_ximgproc -lopencv_xobjdetect -lopencv_objdetect -lopencv_calib3d -lopencv_features2d -lopencv_highgui -lopencv_videoio -lopencv_imgcodecs -lopencv_flann -lopencv_xphoto -lopencv_photo -lopencv_imgproc -lopencv_core
Libs.private: -ldl -lm -lpthread -lrt
Cflags: -I${includedir_old} -I${includedir_new}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;pc 文件中的元数据分为两种，一种是格式如 &lt;code&gt;prefix=**&lt;/code&gt; 的变量，一种是格式如 &lt;code&gt;Name: OpenCV&lt;/code&gt; 关键字，变量是在 pc 文件内部使用，用来帮助定义关键字；而关键字信息会导出到 pkg-config 中。&lt;/p&gt;

&lt;p&gt;pkg-config 中定义了一下这些关键字&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Name: 当前库的名字，它不需要全局唯一，通常它和 pc 文件的文件名保持一致。&lt;/li&gt;
  &lt;li&gt;Description: 对于库的简短描述&lt;/li&gt;
  &lt;li&gt;URL: 当前库的相关信息网络地址&lt;/li&gt;
  &lt;li&gt;Version: 安装的版本号&lt;/li&gt;
  &lt;li&gt;Requires: 列出当前库所需要的依赖，依赖库的版本信息可以使用 =, &amp;gt;, &amp;lt;, &amp;lt;= 和 &amp;gt;= 来指定。 eg. &lt;code&gt;Requires: OpenCV &amp;gt;= 4.0.0&lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;Requires.private: 列出当前库所需要的依赖，但是这些依赖并不会暴露给应用，版本格式与 &lt;code&gt;Requires&lt;/code&gt; 相同。&lt;/li&gt;
  &lt;li&gt;Confilcts: 这是一个可选关键字，用来指明与当前库冲突的库&lt;/li&gt;
  &lt;li&gt;Cflags: 编译当前库需要的 flags 参数。如果依赖的库不支持 pkg-config， 就可以通过此关键字来指定，如果支持 pkg-config，就应该在 &lt;code&gt;Requires&lt;/code&gt; 和 &lt;code&gt;Requires.private&lt;/code&gt; 中指定。&lt;/li&gt;
  &lt;li&gt;Libs: 指定不支持 pkg-config 的链接依赖 flags 参数&lt;/li&gt;
  &lt;li&gt;Libs.private: 同 &lt;code&gt;Requires.private&lt;/code&gt; 一样，当前关键字的依赖不会暴露给应用&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;pkg-config 默认会在 &lt;code&gt;/usr/lib/pkgconfig&lt;/code&gt; 和 &lt;code&gt;/usr/share/pkgconfig&lt;/code&gt; 中去加载 pc 文件，但是有些库的安装地址不在默认路径中，就需要将 pc 文件的路径添加到环境变量 &lt;strong&gt;PKG_CONFIG_PATH&lt;/strong&gt; 中。&lt;/p&gt;

&lt;p&gt;通过 pkg-config 可以查看安装库的版本&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;pkg-config &lt;span class=&quot;nt&quot;&gt;--modversion&lt;/span&gt; opencv4 &lt;span class=&quot;c&quot;&gt;# 如果 pc 文件名与 Name 关键字不一致，这里需要输入的是文件名&lt;/span&gt;
4.0.1
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;code&gt;--libs&lt;/code&gt; 可以输出编译依赖当前库的 link flags， 但是不会输出 /usr/lib 下的依赖库。&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;pkg-config &lt;span class=&quot;nt&quot;&gt;--libs&lt;/span&gt; opencv4
&lt;span class=&quot;nt&quot;&gt;-L&lt;/span&gt;/usr/local/opencv4/lib &lt;span class=&quot;nt&quot;&gt;-lopencv_gapi&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_stitching&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_aruco&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_bgsegm&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_bioinspired&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_ccalib&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_cvv&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_dnn_objdetect&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_dpm&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_face&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_freetype&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_fuzzy&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_hdf&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_hfs&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_img_hash&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_line_descriptor&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_reg&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_rgbd&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_saliency&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_sfm&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_stereo&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_structured_light&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_phase_unwrapping&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_superres&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_optflow&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_surface_matching&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_tracking&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_datasets&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_text&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_dnn&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_plot&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_videostab&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_video&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_xfeatures2d&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_shape&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_ml&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_ximgproc&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_xobjdetect&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_objdetect&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_calib3d&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_features2d&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_highgui&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_videoio&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_imgcodecs&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_flann&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_xphoto&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_photo&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_imgproc&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_core&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;同时 &lt;code&gt;--libs&lt;/code&gt; 也不会输出 OpenCV 的依赖，因为依赖 OpenCV 的代码并不直接依赖与OpenCV 的依赖。为了静态链接，可以加上选项 &lt;code&gt;--static&lt;/code&gt;&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;pkg-config &lt;span class=&quot;nt&quot;&gt;--libs&lt;/span&gt; opencv4
&lt;span class=&quot;nt&quot;&gt;-L&lt;/span&gt;/usr/local/opencv4/lib &lt;span class=&quot;nt&quot;&gt;-lopencv_gapi&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_stitching&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_aruco&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_bgsegm&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_bioinspired&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_ccalib&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_cvv&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_dnn_objdetect&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_dpm&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_face&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_freetype&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_fuzzy&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_hdf&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_hfs&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_img_hash&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_line_descriptor&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_reg&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_rgbd&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_saliency&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_sfm&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_stereo&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_structured_light&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_phase_unwrapping&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_superres&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_optflow&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_surface_matching&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_tracking&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_datasets&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_text&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_dnn&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_plot&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_videostab&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_video&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_xfeatures2d&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_shape&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_ml&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_ximgproc&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_xobjdetect&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_objdetect&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_calib3d&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_features2d&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_highgui&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_videoio&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_imgcodecs&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_flann&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_xphoto&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_photo&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_imgproc&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_core&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-ldl&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lm&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lpthread&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lrt&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;使用 &lt;code&gt;--cflags&lt;/code&gt; pkg-config 会输出所有的编译flag， 加不加 &lt;code&gt;--static&lt;/code&gt; 都一样。&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;pkg-config &lt;span class=&quot;nt&quot;&gt;--cflags&lt;/span&gt; opencv4
&lt;span class=&quot;nt&quot;&gt;-I&lt;/span&gt;/usr/local/opencv4/include/opencv4/opencv &lt;span class=&quot;nt&quot;&gt;-I&lt;/span&gt;/usr/local/opencv4/include/opencv4

pkg-config &lt;span class=&quot;nt&quot;&gt;--cflags&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--static&lt;/span&gt; opencv4
&lt;span class=&quot;nt&quot;&gt;-I&lt;/span&gt;/usr/local/opencv4/include/opencv4/opencv &lt;span class=&quot;nt&quot;&gt;-I&lt;/span&gt;/usr/local/opencv4/include/opencv4
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;使用 pkg-config 可以更加方便的编译C++代码，比如代码 &lt;code&gt;myapp.cpp&lt;/code&gt; 依赖 OpenCV，那么可以使用下面方式来指定编译的flags&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;g++ &lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;pkg-config &lt;span class=&quot;nt&quot;&gt;--cflags&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--libs&lt;/span&gt; opencv4&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-o&lt;/span&gt; myapp myapp.cpp
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;</content><author><name></name></author><category term="c++" /><category term="linux" /><summary type="html">pkg-config 入门 pkg-config 是类 Unix 操作系统上的一个库查询工具。它通过 .pc 文件来查询当前系统上已安装类库的信息。 下面是 OpenCV4 的 pc 文件， 文件中包含了OpenCV 库的很多元数据(metadata) # Package Information for pkg-config prefix=/usr/local/opencv4 exec_prefix=${prefix} libdir=${exec_prefix}/lib includedir_old=${prefix}/include/opencv4/opencv includedir_new=${prefix}/include/opencv4 Name: OpenCV Description: Open Source Computer Vision Library Version: 4.0.1 Libs: -L${exec_prefix}/lib -lopencv_gapi -lopencv_stitching -lopencv_aruco -lopencv_bgsegm -lopencv_bioinspired -lopencv_ccalib -lopencv_cvv -lopencv_dnn_objdetect -lopencv_dpm -lopencv_face -lopencv_freetype -lopencv_fuzzy -lopencv_hdf -lopencv_hfs -lopencv_img_hash -lopencv_line_descriptor -lopencv_reg -lopencv_rgbd -lopencv_saliency -lopencv_sfm -lopencv_stereo -lopencv_structured_light -lopencv_phase_unwrapping -lopencv_superres -lopencv_optflow -lopencv_surface_matching -lopencv_tracking -lopencv_datasets -lopencv_text -lopencv_dnn -lopencv_plot -lopencv_videostab -lopencv_video -lopencv_xfeatures2d -lopencv_shape -lopencv_ml -lopencv_ximgproc -lopencv_xobjdetect -lopencv_objdetect -lopencv_calib3d -lopencv_features2d -lopencv_highgui -lopencv_videoio -lopencv_imgcodecs -lopencv_flann -lopencv_xphoto -lopencv_photo -lopencv_imgproc -lopencv_core Libs.private: -ldl -lm -lpthread -lrt Cflags: -I${includedir_old} -I${includedir_new} pc 文件中的元数据分为两种，一种是格式如 prefix=** 的变量，一种是格式如 Name: OpenCV 关键字，变量是在 pc 文件内部使用，用来帮助定义关键字；而关键字信息会导出到 pkg-config 中。 pkg-config 中定义了一下这些关键字 Name: 当前库的名字，它不需要全局唯一，通常它和 pc 文件的文件名保持一致。 Description: 对于库的简短描述 URL: 当前库的相关信息网络地址 Version: 安装的版本号 Requires: 列出当前库所需要的依赖，依赖库的版本信息可以使用 =, &amp;gt;, &amp;lt;, &amp;lt;= 和 &amp;gt;= 来指定。 eg. Requires: OpenCV &amp;gt;= 4.0.0 Requires.private: 列出当前库所需要的依赖，但是这些依赖并不会暴露给应用，版本格式与 Requires 相同。 Confilcts: 这是一个可选关键字，用来指明与当前库冲突的库 Cflags: 编译当前库需要的 flags 参数。如果依赖的库不支持 pkg-config， 就可以通过此关键字来指定，如果支持 pkg-config，就应该在 Requires 和 Requires.private 中指定。 Libs: 指定不支持 pkg-config 的链接依赖 flags 参数 Libs.private: 同 Requires.private 一样，当前关键字的依赖不会暴露给应用 pkg-config 默认会在 /usr/lib/pkgconfig 和 /usr/share/pkgconfig 中去加载 pc 文件，但是有些库的安装地址不在默认路径中，就需要将 pc 文件的路径添加到环境变量 PKG_CONFIG_PATH 中。 通过 pkg-config 可以查看安装库的版本 pkg-config --modversion opencv4 # 如果 pc 文件名与 Name 关键字不一致，这里需要输入的是文件名 4.0.1 --libs 可以输出编译依赖当前库的 link flags， 但是不会输出 /usr/lib 下的依赖库。 pkg-config --libs opencv4 -L/usr/local/opencv4/lib -lopencv_gapi -lopencv_stitching -lopencv_aruco -lopencv_bgsegm -lopencv_bioinspired -lopencv_ccalib -lopencv_cvv -lopencv_dnn_objdetect -lopencv_dpm -lopencv_face -lopencv_freetype -lopencv_fuzzy -lopencv_hdf -lopencv_hfs -lopencv_img_hash -lopencv_line_descriptor -lopencv_reg -lopencv_rgbd -lopencv_saliency -lopencv_sfm -lopencv_stereo -lopencv_structured_light -lopencv_phase_unwrapping -lopencv_superres -lopencv_optflow -lopencv_surface_matching -lopencv_tracking -lopencv_datasets -lopencv_text -lopencv_dnn -lopencv_plot -lopencv_videostab -lopencv_video -lopencv_xfeatures2d -lopencv_shape -lopencv_ml -lopencv_ximgproc -lopencv_xobjdetect -lopencv_objdetect -lopencv_calib3d -lopencv_features2d -lopencv_highgui -lopencv_videoio -lopencv_imgcodecs -lopencv_flann -lopencv_xphoto -lopencv_photo -lopencv_imgproc -lopencv_core 同时 --libs 也不会输出 OpenCV 的依赖，因为依赖 OpenCV 的代码并不直接依赖与OpenCV 的依赖。为了静态链接，可以加上选项 --static pkg-config --libs opencv4 -L/usr/local/opencv4/lib -lopencv_gapi -lopencv_stitching -lopencv_aruco -lopencv_bgsegm -lopencv_bioinspired -lopencv_ccalib -lopencv_cvv -lopencv_dnn_objdetect -lopencv_dpm -lopencv_face -lopencv_freetype -lopencv_fuzzy -lopencv_hdf -lopencv_hfs -lopencv_img_hash -lopencv_line_descriptor -lopencv_reg -lopencv_rgbd -lopencv_saliency -lopencv_sfm -lopencv_stereo -lopencv_structured_light -lopencv_phase_unwrapping -lopencv_superres -lopencv_optflow -lopencv_surface_matching -lopencv_tracking -lopencv_datasets -lopencv_text -lopencv_dnn -lopencv_plot -lopencv_videostab -lopencv_video -lopencv_xfeatures2d -lopencv_shape -lopencv_ml -lopencv_ximgproc -lopencv_xobjdetect -lopencv_objdetect -lopencv_calib3d -lopencv_features2d -lopencv_highgui -lopencv_videoio -lopencv_imgcodecs -lopencv_flann -lopencv_xphoto -lopencv_photo -lopencv_imgproc -lopencv_core -ldl -lm -lpthread -lrt 使用 --cflags pkg-config 会输出所有的编译flag， 加不加 --static 都一样。 pkg-config --cflags opencv4 -I/usr/local/opencv4/include/opencv4/opencv -I/usr/local/opencv4/include/opencv4 pkg-config --cflags --static opencv4 -I/usr/local/opencv4/include/opencv4/opencv -I/usr/local/opencv4/include/opencv4 使用 pkg-config 可以更加方便的编译C++代码，比如代码 myapp.cpp 依赖 OpenCV，那么可以使用下面方式来指定编译的flags g++ `pkg-config --cflags --libs opencv4` -o myapp myapp.cpp</summary></entry><entry><title type="html">机器学习基石 第二讲</title><link href="https://mengman.github.io/machinelearning/deeplearning/math/2020/07/12/machine-learning-foundations-lession-2.html" rel="alternate" type="text/html" title="机器学习基石 第二讲" /><published>2020-07-12T01:26:21+08:00</published><updated>2020-07-12T01:26:21+08:00</updated><id>https://mengman.github.io/machinelearning/deeplearning/math/2020/07/12/machine-learning-foundations-lession-2</id><content type="html" xml:base="https://mengman.github.io/machinelearning/deeplearning/math/2020/07/12/machine-learning-foundations-lession-2.html">&lt;h1 id=&quot;感知机&quot;&gt;感知机&lt;/h1&gt;

&lt;h2 id=&quot;感知器假设集perceptron-hypothesis-set&quot;&gt;感知器假设集（Perceptron Hypothesis Set）&lt;/h2&gt;
&lt;p&gt;感知器算法:  \(h(x)=sign((\sum_{i=1}^dw_ix_i)-threshold)\)&lt;/p&gt;

&lt;p&gt;对上面的公示进行变形，将&lt;strong&gt;threshold&lt;/strong&gt;作为偏置，纳入 x 中，\(x_0=+1\) ;&lt;/p&gt;

\[h(x)=sign(W^TX)\]

&lt;p&gt;每一个不同的W代表了算法中的一个hypothesis.&lt;/p&gt;

&lt;h2 id=&quot;pla-感知器学习算法&quot;&gt;PLA 感知器学习算法&lt;/h2&gt;

&lt;p&gt;要从 hypothesis set 中找到一个合适的 hypothesis g, 让 g 与目标函数 f 尽可能的相近。&lt;/p&gt;

&lt;p&gt;PLA算法通过试错的方法实现模型的训练：&lt;/p&gt;

&lt;p&gt;总共进行t轮的训练， t=0, 1, …&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;随机初始化 \(w_0\);&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;将样本 \((x_{n(t)},y_{n(t)})\) 带入PLA学习机， 如果：&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;

\[sign(w^T_tx_{n(t)})\neq y_{n(t)}\]

&lt;p&gt;那么，表示发生错误，需要对错误进行纠正。&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;修正错误：&lt;/p&gt;

\[w_{t+1} \leftarrow w_t + y_{n(t)}x_{n(t)}\]

    &lt;p&gt;\(w\): 代表分类线的法向量
\(x_n\): 是原点到 \(x_n\) 的向量&lt;/p&gt;

    &lt;p&gt;&lt;img src=&quot;/assets/ml_base_2_1.png&quot; alt=&quot;ml_base_2_1&quot; /&gt;&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;ul&gt;
  &lt;li&gt;当 \(y_n = +1\), 将 \(w\) 的方向向样本 \((x_n, y_n)\) 的方向转动。&lt;/li&gt;
  &lt;li&gt;当 \(y_n = -1\), 将\(w\)的方向向样本 \((x_n, y_n)\) 的反方向转动。&lt;/li&gt;
  &lt;li&gt;当不再出现错误的时候，训练结束。&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;strong&gt;PLA算法要能终止，要求训练数据集必须是线性可分的&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;\(w_t\) 越来越接近 \(w_f\)&lt;/strong&gt;&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;\(w_f\): 目标函数 f 对应的参数，因此对于任意一个样本，它都能正确的分类：&lt;/p&gt;

\[y_{n(t)}w^T_fx_{n(t)} \ge \min_ny_nw^T_fx_n \gt 0\]
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;衡量两个向量是否接近，可以用它们的内积，如果内积越小代表它们越不接近，相互垂直时为 0&lt;/p&gt;

\[\begin{align}
\begin{split}
w_f^Tw_{t+1} &amp;amp;= w_f^T(w_t+y_{n(t)}x_{n(t)}) \\
&amp;amp;\ge w_f^Tw_t + \min_ny_nw_f^Tx_n \\
&amp;amp;\gt w_f^Tw_t + 0
\end{split}
\end{align}\]
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;strong&gt;\(w_t\) 的增长速率不快&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;\(w_t\)每次的更新不超过离分割线最远的样本的距离&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;\(w_t\) 的每次更新发生在有错误的时候：&lt;/li&gt;
&lt;/ul&gt;

\[sign(w_t^fx_{n(t)}) \neq y_{n(t)} \Leftrightarrow y_{n(t)}w_t^Tx_{n(t)} \leq 0\]

&lt;ul&gt;
  &lt;li&gt;对于每一次更新后的结果：&lt;/li&gt;
&lt;/ul&gt;

\[\begin{equation}\begin{split} ||w_{t+1}||^2 &amp;amp;= ||w_t + y_{n(t)}x_{n(t)}||^2\\\\
   &amp;amp;= ||w_t||^2 + 2y_{n(t)}w_t^Tx_{n(t)} + ||y_{n(t)}x_{n(t)}||^2\\\\
   &amp;amp;\le ||w_t||^2 + 0 + ||y_{n(t)x_{n(t)}}||^2\\\\
   &amp;amp;\le ||w_t||^2 + \max_n||y_{n(t)}x_{n(t)}||^2\end{split}\end{equation}\]

&lt;p&gt;其中  \(\max_n \Vert y_{n(t)}x_{n(t)} \Vert ^2\)  就代表了距离到分隔线最远的点的距离。&lt;/p&gt;

\[\begin{equation}\begin{split}
   \text{start from w_0 = 0, after T mistake corrections,} \\
   
   \frac{w_f^T}{\Vert w_f \Vert} \frac{w_T}{\Vert w_T \Vert} \ge \sqrt T * \text{constant}
   
   \end{split}\end{equation}\]

&lt;p&gt;\(w_f^Tw_{t+1}\) 的内积是小于等于1的，再根据上面的式子，知道T不可能为无穷大，所以运算会终止。&lt;/p&gt;

&lt;h2 id=&quot;pocket-算法&quot;&gt;Pocket 算法&lt;/h2&gt;
&lt;p&gt;&lt;strong&gt;算法步骤&lt;/strong&gt;&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;随机初始化 w&lt;/li&gt;
  &lt;li&gt;进行 t 轮的学习， t = 0, 1, …&lt;/li&gt;
  &lt;li&gt;如果发生错误，按照 PLA 算法对 w进行纠正：\(w_{t+1} \leftarrow w_t + y_{n(t)}x_{n(t)}\)&lt;/li&gt;
  &lt;li&gt;判断对比纠正后的算法与之前算法的错误率，如果更好，者保留新的w&lt;sub&gt;t+1&lt;/sub&gt;, 否者保留之前的w。&lt;/li&gt;
  &lt;li&gt;运算足够多次之后停止运算。&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;Pocket算法是PLA的改进算法，用于解决&lt;strong&gt;线性不可分&lt;/strong&gt;的数据集。
Pocket算法的运算量大：对于比PLA，在得到新的w&lt;sub&gt;t+1&lt;/sub&gt;， 需要将所有数据集运算一遍，来获得错误率。&lt;/p&gt;</content><author><name></name></author><category term="machinelearning" /><category term="deeplearning" /><category term="math" /><summary type="html">感知机 感知器假设集（Perceptron Hypothesis Set） 感知器算法: \(h(x)=sign((\sum_{i=1}^dw_ix_i)-threshold)\) 对上面的公示进行变形，将threshold作为偏置，纳入 x 中，\(x_0=+1\) ; \[h(x)=sign(W^TX)\] 每一个不同的W代表了算法中的一个hypothesis. PLA 感知器学习算法 要从 hypothesis set 中找到一个合适的 hypothesis g, 让 g 与目标函数 f 尽可能的相近。 PLA算法通过试错的方法实现模型的训练： 总共进行t轮的训练， t=0, 1, … 随机初始化 \(w_0\); 将样本 \((x_{n(t)},y_{n(t)})\) 带入PLA学习机， 如果： \[sign(w^T_tx_{n(t)})\neq y_{n(t)}\] 那么，表示发生错误，需要对错误进行纠正。 修正错误： \[w_{t+1} \leftarrow w_t + y_{n(t)}x_{n(t)}\] \(w\): 代表分类线的法向量 \(x_n\): 是原点到 \(x_n\) 的向量 当 \(y_n = +1\), 将 \(w\) 的方向向样本 \((x_n, y_n)\) 的方向转动。 当 \(y_n = -1\), 将\(w\)的方向向样本 \((x_n, y_n)\) 的反方向转动。 当不再出现错误的时候，训练结束。 PLA算法要能终止，要求训练数据集必须是线性可分的 \(w_t\) 越来越接近 \(w_f\) \(w_f\): 目标函数 f 对应的参数，因此对于任意一个样本，它都能正确的分类： \[y_{n(t)}w^T_fx_{n(t)} \ge \min_ny_nw^T_fx_n \gt 0\] 衡量两个向量是否接近，可以用它们的内积，如果内积越小代表它们越不接近，相互垂直时为 0 \[\begin{align} \begin{split} w_f^Tw_{t+1} &amp;amp;= w_f^T(w_t+y_{n(t)}x_{n(t)}) \\ &amp;amp;\ge w_f^Tw_t + \min_ny_nw_f^Tx_n \\ &amp;amp;\gt w_f^Tw_t + 0 \end{split} \end{align}\] \(w_t\) 的增长速率不快 \(w_t\)每次的更新不超过离分割线最远的样本的距离 \(w_t\) 的每次更新发生在有错误的时候： \[sign(w_t^fx_{n(t)}) \neq y_{n(t)} \Leftrightarrow y_{n(t)}w_t^Tx_{n(t)} \leq 0\] 对于每一次更新后的结果： \[\begin{equation}\begin{split} ||w_{t+1}||^2 &amp;amp;= ||w_t + y_{n(t)}x_{n(t)}||^2\\\\ &amp;amp;= ||w_t||^2 + 2y_{n(t)}w_t^Tx_{n(t)} + ||y_{n(t)}x_{n(t)}||^2\\\\ &amp;amp;\le ||w_t||^2 + 0 + ||y_{n(t)x_{n(t)}}||^2\\\\ &amp;amp;\le ||w_t||^2 + \max_n||y_{n(t)}x_{n(t)}||^2\end{split}\end{equation}\] 其中 \(\max_n \Vert y_{n(t)}x_{n(t)} \Vert ^2\) 就代表了距离到分隔线最远的点的距离。 \[\begin{equation}\begin{split} \text{start from w_0 = 0, after T mistake corrections,} \\ \frac{w_f^T}{\Vert w_f \Vert} \frac{w_T}{\Vert w_T \Vert} \ge \sqrt T * \text{constant} \end{split}\end{equation}\] \(w_f^Tw_{t+1}\) 的内积是小于等于1的，再根据上面的式子，知道T不可能为无穷大，所以运算会终止。 Pocket 算法 算法步骤 随机初始化 w 进行 t 轮的学习， t = 0, 1, … 如果发生错误，按照 PLA 算法对 w进行纠正：\(w_{t+1} \leftarrow w_t + y_{n(t)}x_{n(t)}\) 判断对比纠正后的算法与之前算法的错误率，如果更好，者保留新的wt+1, 否者保留之前的w。 运算足够多次之后停止运算。 Pocket算法是PLA的改进算法，用于解决线性不可分的数据集。 Pocket算法的运算量大：对于比PLA，在得到新的wt+1， 需要将所有数据集运算一遍，来获得错误率。</summary></entry><entry><title type="html">软件设计模型-功能开关</title><link href="https://mengman.github.io/designpattern/softwareengineering/2020/04/20/Feature-Toggles.html" rel="alternate" type="text/html" title="软件设计模型-功能开关" /><published>2020-04-20T17:26:21+08:00</published><updated>2020-04-20T17:26:21+08:00</updated><id>https://mengman.github.io/designpattern/softwareengineering/2020/04/20/Feature-Toggles</id><content type="html" xml:base="https://mengman.github.io/designpattern/softwareengineering/2020/04/20/Feature-Toggles.html">&lt;h2 id=&quot;功能开关&quot;&gt;功能开关&lt;/h2&gt;
&lt;p&gt;本文受到 Pete Hodgson 的文章 &lt;a href=&quot;https://www.martinfowler.com/articles/feature-toggles.html&quot;&gt;Feature Toggles (aka Feature Flags)&lt;/a&gt; 启发，原文内容比本文更加丰富。&lt;/p&gt;

&lt;h3 id=&quot;简单的功能开关&quot;&gt;简单的功能开关&lt;/h3&gt;

&lt;p&gt;场景一：你刚刚开发完一个新的功能，然后需求告诉你，由于这个功能使用场景的限制，需要添加一个开关，能够让这个功能在某些环境打开或者关闭。&lt;/p&gt;

&lt;p&gt;场景二：你实现了一个新版本的算法，但是并不希望立刻在线上启用，希望能进行更多的测试，所以需要添加一个开关，在测试环境打开，在生产环境保持关闭。&lt;/p&gt;

&lt;p&gt;这个时候你只需要实现一个简单的功能开关即可。&lt;/p&gt;

&lt;div class=&quot;language-go highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;doSomeThing&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;useNewAlgorithm&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;false&lt;/span&gt;
    &lt;span class=&quot;c&quot;&gt;// useNewAlgorithm := true // uncomment if you working with new algorithm&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;useNewAlgoritem&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;doSomeThingNew&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;doSomeThingOld&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;doSomeThingNew&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;c&quot;&gt;// implement something new&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;doSomeThingOld&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;c&quot;&gt;// implement something old&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;我们把新的功能写到 &lt;code&gt;doSomeThingNew&lt;/code&gt; 函数中，并通过 &lt;code&gt;useNewAlgorithm&lt;/code&gt; 变量来控制是否调用新功能。这个方法虽然简单，但是我们无法在运行时动态的去决定是否启用新的功能。为了实现对于新功能的动态控制，我们可以引入一个&lt;strong&gt;开关路由器&lt;/strong&gt;（toggle router）来实现。&lt;/p&gt;

&lt;h3 id=&quot;开关路由器&quot;&gt;开关路由器&lt;/h3&gt;

&lt;div class=&quot;language-go highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ToggleRouter&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;featureConfig&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;map&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tr&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ToggleRouter&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;SetFeature&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;featureName&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;isEnabled&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;bool&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;isEnabled&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;tr&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;featureConfig&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;featureName&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{}{}&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;nb&quot;&gt;delete&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tr&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;featureConfig&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;featureName&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tr&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ToggleRouter&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;IsFeatureEnabled&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;featureName&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;bool&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ok&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;tr&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;featureConfig&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;featureName&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ok&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;NewToggleRouter&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;features&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tr&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ToggleRouter&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;tr&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ToggleRouter&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;featureConfig&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;make&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;map&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{}),&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

	&lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;feat&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;range&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;features&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;tr&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;SetFeature&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;feat&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

	&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;toggleRouter&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;NewToggleRouter&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;([]&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;newAlgo&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;})&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;doSomeThing&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;toggleRouter&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;IsFeatureEnabled&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;newAlgo&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;doSomeThingNew&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;doSomeThingOld&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;通过开关路由器我们可以动态的设置功能的启用与否。ToggleRouter 可以通过配置文件创建，或者通过配置界面，或者 API 接口来进行配置。到现在问题似乎已经解决了，然而随着越来越多的新功能加入，越来越多的功能需要通过开关来配置是否开启，代码中出现了越来越多的&lt;strong&gt;开关点&lt;/strong&gt;，代码也变得越来越难以理解和维护。&lt;/p&gt;

&lt;p&gt;让我们看一个新例子，&lt;code&gt;InvoiceEmailler&lt;/code&gt; 会根据收据发送一封电子邮件，现在我们希望能加上一个新的功能，在邮件中添加退货链接。而这个退货链接只是在特定的情况下才会触发。下面代码中是根据 开关中是否包含 &lt;code&gt;next-gen-ecomm&lt;/code&gt; 来判断的。&lt;/p&gt;

&lt;div class=&quot;language-go highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;toggle&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;GetFeatureToggleRouter&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;InvoiceEmailler&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;invoice&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Invoice&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;emailler&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;InvoiceEmailler&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;GenerateInvoiceEmail&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Email&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;baseEmail&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;buildEmailForInvoice&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;emailler&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;invoice&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;toggle&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;IsFeatureEnabled&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;next-gen-ecomm&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;addOrderCallationContentToEmail&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;baseEmail&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;baseEmail&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;但是，对于一个功能是否启用的判断逻辑可能是十分复杂的，也许在 A 情况下需要开启，在 B 情况下需要关闭；或者需要对某一部分用户开启这一项功能，对另一部分用户关闭这一功能；开关的判断逻辑可能会频繁的迭代。如果要更新判断逻辑，我们不得不在每个开关点去修改判断逻辑。这是代码中的第一个问题：&lt;strong&gt;开关点与开关的判断逻辑耦合在一起&lt;/strong&gt;。&lt;/p&gt;

&lt;h3 id=&quot;解耦开关点与开关路由器&quot;&gt;解耦开关点与开关路由器&lt;/h3&gt;

&lt;p&gt;幸好&lt;a href=&quot;https://en.wikipedia.org/wiki/Fundamental_theorem_of_software_engineering&quot;&gt;“软件中的任何问题都可以通过引入一个间接层来解决”&lt;/a&gt;, 通过增加一个&lt;strong&gt;开关逻辑判断层&lt;/strong&gt;我们可以解耦开关点与开关判断逻辑。&lt;/p&gt;

&lt;div class=&quot;language-go highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FeatureDecisions&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;toggle&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ToggleRouter&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;descisions&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FeatureDecisions&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;IncludeOrderCancellationInEmail&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;bool&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;descisions&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;toggle&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;IsFeatureEnabled&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;new-gen-ecomm&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;NewFeatureDecisions&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;toggle&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ToggleRouter&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FeatureDecisions&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FeatureDecisions&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;toggle&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;toggle&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;


&lt;span class=&quot;k&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;toggle&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;GetFeatureToggleRouter&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;featureDecisions&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;NewFeatureDecision&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;toggle&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;InvoiceEmailler&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;invoice&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Invoice&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;emailler&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;InvoiceEmailler&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;GenerateInvoiceEmail&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Email&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;baseEmail&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;buildEmailForInvoice&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;emailler&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;invoice&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;featureDecisions&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;IncludeOrderCancellationInEmail&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;addOrderCallationContentToEmail&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;baseEmail&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;baseEmail&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;通过引入 &lt;code&gt;FeatureDecisions&lt;/code&gt; 之后，&lt;code&gt;InvoiceEmailler&lt;/code&gt; 不再关心添加退货链接的逻辑是什么；而后续对与添加退货链接逻辑的更新也与 &lt;code&gt;InvoiceEmailler&lt;/code&gt; 无关。从而实现了&lt;strong&gt;开关点与开关判断逻辑的解耦&lt;/strong&gt;。&lt;/p&gt;

&lt;h3 id=&quot;判断翻转inversion-of-decision&quot;&gt;判断翻转(Inversion of Decision)&lt;/h3&gt;

&lt;p&gt;虽然在上一步中，我们通过添加&lt;strong&gt;判断逻辑层&lt;/strong&gt;实现了判断逻辑与开关点的解耦，但是 &lt;code&gt;InvoiceEmailler&lt;/code&gt; 依旧与 &lt;code&gt;FeatureDecisions&lt;/code&gt; 耦合在一起，在执行 &lt;code&gt;GenerateInvoiceEmail()&lt;/code&gt; 需要先创建或者获取 &lt;code&gt;FeatureDecisions&lt;/code&gt; ，这处代码“坏味道”带来了两个问题：&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;它不方便对代码进行测试，在测试 &lt;code&gt;GenerateInvoiceEmail()&lt;/code&gt; 函数之前，我们必须先设置好调用 &lt;code&gt;GetFeatureToggleRouter()&lt;/code&gt; 与 &lt;code&gt;NewFeatureDecision()&lt;/code&gt; 函数的环境，才能确保可以到达待测试逻辑代码块。&lt;/li&gt;
  &lt;li&gt;随着项目功能模块的增多，每个模块都与 &lt;code&gt;FeatureDecisions&lt;/code&gt; 模块发生了耦合，使得该模块变成了全局依赖模块。&lt;/li&gt;
&lt;/ol&gt;

&lt;div class=&quot;language-go highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;// invoice_emailler.go&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;EmaillerDecisions&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;interface&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;IncludeOrderCancellationInEmail&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;bool&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;InvoiceEmailler&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;invoice&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Invoice&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;decisions&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;EmaillerDecisions&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;emailler&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;InvoiceEmailler&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;SetDecisions&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;decisions&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FeatureDecisions&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;emailler&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;decisions&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;decisions&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;emailler&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;InvoiceEmailler&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;GenerateInvoiceEmail&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Email&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;baseEmail&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;buildEmailForInvoice&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;emailler&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;invoice&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;emailler&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;decisions&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;includeOrderCancellationInEmail&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;addOrderCallationContentToEmail&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;baseEmail&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;baseEmail&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;// inject decisions module&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;NewInvoiceEmailler&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;decisions&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;EmaillerDecisions&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;，&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;invoice&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Invoice&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;InvoiceEmailler&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;InvoiceEmailler&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;invoice&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;invoice&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;decisions&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;decisions&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;此处“坏味道”的根本原因是业务模块对 &lt;code&gt;FeatureDecisions&lt;/code&gt; 模块的依赖，通过&lt;strong&gt;控制反转&lt;/strong&gt;在 &lt;code&gt;InvoiceEmailler&lt;/code&gt; 模块创建时，将 &lt;code&gt;FeatureDecisions&lt;/code&gt; 注入到 &lt;code&gt;InvoiceEmailler&lt;/code&gt; 中，就可以消除业务模块对与 &lt;code&gt;FeatureDecisions&lt;/code&gt; 模块的依赖。&lt;/p&gt;

&lt;h3 id=&quot;消除条件判断&quot;&gt;消除条件判断&lt;/h3&gt;

&lt;p&gt;到现在位置我们代码已经获得了很大优化，那我们能不能在进一步消除 &lt;code&gt;GenerateInvoiceEmail()&lt;/code&gt; 函数的条件判断呢？ 对于简单的场景下的条件判断语句是没有什么问题的，但是在复杂的业务逻辑中，太多的条件判断并不利于代码的维护。比如如果配置中包含 feature “after-sales-service”,  需要在 email 中添加售后服务的信息。现在我们必须回到  &lt;code&gt;GenerateInvoiceEmail()&lt;/code&gt;，修改判断条件再加上添加售后服务的信息。&lt;/p&gt;

&lt;p&gt;通过策略模式，我们可以进一步的消除业务代码中的逻辑判断，提升代码的可扩展性。&lt;/p&gt;

&lt;div class=&quot;language-go highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
&lt;span class=&quot;k&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;EmaillerDecisions&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;interface&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;IncludeOrderCancellationInEmail&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;bool&lt;/span&gt;

	&lt;span class=&quot;n&quot;&gt;IncludeAfterSalesServiceInEmail&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;bool&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;AdditionalContentEnhancer&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;interface&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;EnhanceContent&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Email&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Email&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;InvoiceEmailler&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;invoice&lt;/span&gt;  &lt;span class=&quot;n&quot;&gt;Invoice&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;enhancer&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;AdditionalContentEnhancer&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;emailler&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;InvoiceEmailler&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;GenerateInvoiceEmail&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Email&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;baseEmail&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;buildEmailForInvoice&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;emailler&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;invoice&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;enhancer&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;EnhanceContent&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;baseEmail&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;OrderCallationContentEnhancer&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;e&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;OrderCallationContentEnhancer&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;addOrderCallationContentToEmail&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;email&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Email&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;newEmail&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Email&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;c&quot;&gt;// implement addOrderCallationContentToEmail&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;e&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;OrderCallationContentEnhancer&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;EnhanceContent&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;email&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Email&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Email&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;addOrderCallationContentToEmail&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;email&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;AfterSalesServiceContentEnhancer&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;e&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;AfterSalesServiceContentEnhancer&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;addAfterSalesServiceContentToEmail&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;email&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Email&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;newEmail&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Email&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;c&quot;&gt;// implement addAfterSalesServiceContentToEmail&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;e&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;AfterSalesServiceContentEnhancer&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;EnhanceContent&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;email&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Email&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Email&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;addAfterSalesServiceContentToEmail&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;email&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;OrderCallationAndAfterSalesServiceContentEnhancer&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;OrderCallationContentEnhancer&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;AfterSalesServiceContentEnhancer&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;e&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;OrderCallationAndAfterSalesServiceContentEnhancer&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;EnhanceContent&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;email&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Email&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Email&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;email&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;OrderCallationContentEnhancer&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;EnhanceContent&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;email&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;email&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;AfterSalesServiceContentEnhancer&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;EnhanceContent&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;email&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;email&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;IdentityContentEnhancer&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;e&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;IdentityContentEnhancer&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;EnhanceContent&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;email&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Email&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Email&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;email&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;// inject decisions module&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;NewInvoiceEmailler&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;decisions&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;EmaillerDecisions&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;invoice&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Invoice&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;InvoiceEmailler&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;emailler&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;InvoiceEmailler&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;invoice&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;invoice&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;decisions&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;IncludeOrderCancellationInEmail&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;decisions&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;IncludeAfterSalesServiceInEmail&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;emailler&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;enhancer&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;OrderCallationAndAfterSalesServiceContentEnhancer&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{}&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;decisions&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;IncludeOrderCancellationInEmail&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;emailler&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;enhancer&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;OrderCallationContentEnhancer&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{}&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;decisions&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;IncludeAfterSalesServiceInEmail&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;emailler&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;enhancer&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;AfterSalesServiceContentEnhancer&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{}&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;emailler&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;enhancer&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;IdentityContentEnhancer&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{}&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

	&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;到现在我们就差不多完成了对于代码的优化。&lt;/p&gt;</content><author><name></name></author><category term="designpattern" /><category term="softwareengineering" /><summary type="html">功能开关 本文受到 Pete Hodgson 的文章 Feature Toggles (aka Feature Flags) 启发，原文内容比本文更加丰富。</summary></entry><entry><title type="html">Python 依赖管理软件 Poetry 上手</title><link href="https://mengman.github.io/designpattern/softwareengineering/2020/04/20/Python-Poetry-In-Action.html" rel="alternate" type="text/html" title="Python 依赖管理软件 Poetry 上手" /><published>2020-04-20T17:26:21+08:00</published><updated>2020-04-20T17:26:21+08:00</updated><id>https://mengman.github.io/designpattern/softwareengineering/2020/04/20/Python-Poetry-In-Action</id><content type="html" xml:base="https://mengman.github.io/designpattern/softwareengineering/2020/04/20/Python-Poetry-In-Action.html">&lt;h2 id=&quot;python-项目管理-poetry-上手&quot;&gt;Python 项目管理 Poetry 上手&lt;/h2&gt;

&lt;p&gt;Python 项目依赖管理工具有 virtualenv pipenv anaconda，来帮助项目做到项目之间的环境隔离，依赖管理等。今天介绍的 Poetry 是它更像是 Python 项目 CLI 工具，能够进行项目模板创建，依赖管理，项目构建与发布等。Poetry v0.1.0 版本发布2018-02，到现在两年的时间，目前社区比较活跃。&lt;/p&gt;

&lt;h3 id=&quot;poetry-配置&quot;&gt;Poetry 配置&lt;/h3&gt;

&lt;h4 id=&quot;1--安装&quot;&gt;1  安装&lt;/h4&gt;

&lt;p&gt;OSX / Linux / bashonwindows 使用脚本自动安装&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl &lt;span class=&quot;nt&quot;&gt;-sSL&lt;/span&gt; https://raw.githubusercontent.com/python-poetry/poetry/master/get-poetry.py | python
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;在类 *nix 的系统中 Poetry 会默认安装在 &lt;code&gt;$HOME/.poetry/bin &lt;/code&gt; 中， 在window系统下默认安装目录为 &lt;code&gt;%USERPROFILE%\.poetry\bin&lt;/code&gt;。&lt;/p&gt;

&lt;p&gt;如果要修改安装目录，需要在运行安装脚本时通过环境变量 &lt;code&gt;POETRY_HOME&lt;/code&gt; 来指定。 使用参数 &lt;code&gt;--version&lt;/code&gt; 或者环境变量 &lt;code&gt;POETRY_VERSION&lt;/code&gt; 可以指定安装版本。&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;POETRY_HOME&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/etc/poetry python get-poetry.py &lt;span class=&quot;nt&quot;&gt;--version&lt;/span&gt; 1.0.5
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h4 id=&quot;2-安装检查&quot;&gt;2. 安装检查&lt;/h4&gt;

&lt;p&gt;安装成功后检查 poetry 版本&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;poetry &lt;span class=&quot;nt&quot;&gt;--version&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;如果无法找到  &lt;code&gt;poetry&lt;/code&gt; 命令， 那么记得把安装目录加到 $PATH 中。&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;export&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$PATH&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$HOME&lt;/span&gt;/.poetry/bin:&lt;span class=&quot;nv&quot;&gt;$PATH&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h4 id=&quot;3更新卸载-poetry&quot;&gt;3.更新&amp;amp;卸载 Poetry&lt;/h4&gt;

&lt;p&gt;更新 Poetry&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# 更新到最新的稳定版本&lt;/span&gt;
poetry self update

&lt;span class=&quot;c&quot;&gt;# 更新到预览版本&lt;/span&gt;
poetry self udpate &lt;span class=&quot;nt&quot;&gt;--preview&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;# 更新到指定版本&lt;/span&gt;
poetry self update 1.0.5
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;卸载 Poetry&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;python get-poetry.py &lt;span class=&quot;nt&quot;&gt;--uninstall&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;基本用法&quot;&gt;基本用法&lt;/h3&gt;</content><author><name></name></author><category term="designpattern" /><category term="softwareengineering" /><summary type="html">Python 项目管理 Poetry 上手</summary></entry><entry><title type="html">Large Kernel Matters - Improve Semantic Segmentation by Global Convolutional Network</title><link href="https://mengman.github.io/machinelearning/deeplearning/math/2019/07/29/Large-Kernel-Matters-Improve-Semantic-Segmentation-by-Global-Convolutional-Network.html" rel="alternate" type="text/html" title="Large Kernel Matters - Improve Semantic Segmentation by Global Convolutional Network" /><published>2019-07-29T17:26:21+08:00</published><updated>2019-07-29T17:26:21+08:00</updated><id>https://mengman.github.io/machinelearning/deeplearning/math/2019/07/29/Large-Kernel-Matters-Improve-Semantic-Segmentation-by-Global-Convolutional-Network</id><content type="html" xml:base="https://mengman.github.io/machinelearning/deeplearning/math/2019/07/29/Large-Kernel-Matters-Improve-Semantic-Segmentation-by-Global-Convolutional-Network.html">&lt;p&gt;&lt;strong&gt;论文题目:&lt;/strong&gt; Large Kernel Matters - Improve Semantic Segmentation by Global Convolutional Network&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;论文内容:&lt;/strong&gt; 使用全局卷积网络(GCN)解决分割模型中分类与分割任务冲突的问题，使用Boundary Refinement block 提升物体边缘的分割能力。&lt;/p&gt;

&lt;h1 id=&quot;论文亮点&quot;&gt;论文亮点&lt;/h1&gt;

&lt;blockquote&gt;
  &lt;ol&gt;
    &lt;li&gt;Classification and localization are two naturally contradictory tasks. For the classification task, the models are required to be invariant to various transformations like translation and rotation. But for localization task, models should be transformation-sensitive, precisely locate every pixel for each semantic category.&lt;/li&gt;
  &lt;/ol&gt;
&lt;/blockquote&gt;

&lt;h1 id=&quot;approach&quot;&gt;Approach&lt;/h1&gt;

&lt;h2 id=&quot;global-convolutional-network&quot;&gt;Global Convolutional Network&lt;/h2&gt;

&lt;p&gt;GCN 的目的是同时满足在分割网络中对于分类和定位的需求。从定位任务的要求来说网络结构是一个不包含全连接和全局池化的全卷积结构，因为全局池化会抹去定位信息；从分类角度来说网络需要稠密连接结构，所以卷积核的尺寸应该尽可能的大。&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/1560924841688.png&quot; alt=&quot;1560924841688&quot; /&gt;&lt;/p&gt;

&lt;p&gt;GCN中使用 1×k + k×1 的卷积核来代替 k×k的卷积核降低计算量。&lt;/p&gt;

&lt;h2 id=&quot;boundary-refinement&quot;&gt;Boundary Refinement&lt;/h2&gt;

&lt;p&gt;BR 块是一种残差结构，用于优化物体边缘分割的能力&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/1560925157354.png&quot; alt=&quot;1560925157354&quot; /&gt;&lt;/p&gt;</content><author><name></name></author><category term="machinelearning" /><category term="deeplearning" /><category term="math" /><summary type="html">论文题目: Large Kernel Matters - Improve Semantic Segmentation by Global Convolutional Network</summary></entry><entry><title type="html">On large-batch training for deep leanring: generalization gap and sharp minima 笔记</title><link href="https://mengman.github.io/machinelearning/deeplearning/math/2019/07/29/On-large-batch-training-for-deep-learning-generalization-gap-and-sharp-minima.html" rel="alternate" type="text/html" title="On large-batch training for deep leanring: generalization gap and sharp minima 笔记" /><published>2019-07-29T17:26:21+08:00</published><updated>2019-07-29T17:26:21+08:00</updated><id>https://mengman.github.io/machinelearning/deeplearning/math/2019/07/29/On-large-batch-training-for-deep-learning-generalization-gap-and-sharp-minima</id><content type="html" xml:base="https://mengman.github.io/machinelearning/deeplearning/math/2019/07/29/On-large-batch-training-for-deep-learning-generalization-gap-and-sharp-minima.html">&lt;p&gt;&lt;strong&gt;论文题目:&lt;/strong&gt; On large-batch training for deep leanring: generalization gap and sharp minima&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;论文内容：&lt;/strong&gt; 在SGD中使用较大的batch-size会导致模型的泛化能力退化，因为较大的batch size 模型更加容易在 sharp minima处收敛，较小的batch size使模型在 flat minima处收敛。&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;论文亮点&lt;/strong&gt;&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Many theoretical properties of these methods (SGD and its variants) are known. These include guarantees of:&lt;/p&gt;

  &lt;p&gt;(a) convergence to minimizers of strongly-convex functions and to stationary points for non-convex functions,&lt;/p&gt;

  &lt;p&gt;(b) saddle-point avoidance and&lt;/p&gt;

  &lt;p&gt;(c) robustness to input data.&lt;/p&gt;

  &lt;p&gt;Stochastic gradient methods have, however, a major drawback: owing to the sequential nature of the iteration and small batch sizes, there is limited avenue for parallelization.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h3 id=&quot;大-batch-size-的缺点&quot;&gt;大 batch size 的缺点&lt;/h3&gt;

&lt;p&gt;大 batch size 的泛化能力差是因为，它倾向收敛在 sharp minima 处。 极小值的 sharpness 是由 \(\nabla ^2 f(x)\) 正特征值的大小来决定的，特征值越大，极小值就越 sharp， 泛化能力也就越差。&lt;/p&gt;</content><author><name></name></author><category term="machinelearning" /><category term="deeplearning" /><category term="math" /><summary type="html">论文题目: On large-batch training for deep leanring: generalization gap and sharp minima</summary></entry><entry><title type="html">Population based Augmentation: Efficient Learning of Augmentation Policy Schedules 笔记</title><link href="https://mengman.github.io/machinelearning/deeplearning/math/2019/07/29/Population-based-Augmentation.html" rel="alternate" type="text/html" title="Population based Augmentation: Efficient Learning of Augmentation Policy Schedules 笔记" /><published>2019-07-29T17:26:21+08:00</published><updated>2019-07-29T17:26:21+08:00</updated><id>https://mengman.github.io/machinelearning/deeplearning/math/2019/07/29/Population-based-Augmentation</id><content type="html" xml:base="https://mengman.github.io/machinelearning/deeplearning/math/2019/07/29/Population-based-Augmentation.html">&lt;p&gt;&lt;strong&gt;论文名称：&lt;/strong&gt; Population based Augmentation: Efficient Learning of Augmentation Policy Schedules&lt;/p&gt;</content><author><name></name></author><category term="machinelearning" /><category term="deeplearning" /><category term="math" /><summary type="html">论文名称： Population based Augmentation: Efficient Learning of Augmentation Policy Schedules</summary></entry><entry><title type="html">Softmax Cross Entropy Loss笔记</title><link href="https://mengman.github.io/machinelearning/deeplearning/math/2019/02/22/softmax-cross-entropy-loss.html" rel="alternate" type="text/html" title="Softmax Cross Entropy Loss笔记" /><published>2019-02-22T17:26:21+08:00</published><updated>2019-02-22T17:26:21+08:00</updated><id>https://mengman.github.io/machinelearning/deeplearning/math/2019/02/22/softmax-cross-entropy-loss</id><content type="html" xml:base="https://mengman.github.io/machinelearning/deeplearning/math/2019/02/22/softmax-cross-entropy-loss.html">&lt;h2 id=&quot;softmax函数&quot;&gt;Softmax函数&lt;/h2&gt;
&lt;p&gt;Softmax函数是在机器学习做分类预测中一个重要的工具函数。Softmax函数的数学定义如下：&lt;/p&gt;

\[\sigma(z)_j = \frac{e^{z_j}}{\sum_{k=1}^Ne^{z_k}} 
\text{ for }j = 1, ..., N  \text{ and } \mathbf{z} = (z_1, z_2, ..., z_k)\]

&lt;p&gt;如果用神经网络做一个分类手写数字预测，那么神经网络的最后一层有10个输出，分别作为预测为 0 ~ 9 的概率。那么怎么判断预测结果到底是哪个数字呢？ 一个简单的方法是找到10个输出里最大的那个作为预测结果。 但是这10个输出是相互独立的，其和不等于1。所以一个更好的办法是将所有的输出的和缩放到1，然后看每个输出占的比重，将这个值作为预测概率，而 Softmax 函数恰好可以做到这一点。对于分类  i  的预测概率为  \(p_i =\sigma(z)_i\)&lt;/p&gt;

&lt;p&gt;Softmax 函数非常好实现，下面是用 numpy 实现的 Softmax&lt;/p&gt;

&lt;div class=&quot;language-python highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;softmax&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;X&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;):&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;exps&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;np&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;exp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;X&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;exps&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;np&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;exps&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;在实现 Softmax 函数的时候，由于涉及到指数运算，在输出比较大的时候，非常容易造成结果溢出。
为了使得 softmax 函数在数值上更加稳定，我们可以先对 $\mathbf{z}$ 进行 normalization 。 Normalization 除了统计学上的&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;标准分&lt;/code&gt;( \(\frac{\mathbf{X} - \mu}{\sigma}\) ) , 机器学习中还常用三种其他的方法： L1, L2 和 max&lt;/p&gt;

&lt;p&gt;L1: \(\frac{\mathbf{z}}{\sum_{i=1}^n{\vert z_i \vert }}\)&lt;/p&gt;

&lt;p&gt;L2:  \(\frac{\mathbf{z}}{\sqrt{\sum_{i=1}^n{z_i^2}}}\)&lt;/p&gt;

&lt;p&gt;max: \(\frac{\mathbf{z}}{\max{\mathbf{z}}}\)&lt;/p&gt;

&lt;p&gt;于是可以把上面的代码改写为&lt;/p&gt;
&lt;div class=&quot;language-python highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;stable_softmax&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;X&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;):&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;exps&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;np&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;exp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;X&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;np&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;max&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;X&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;exps&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;np&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;exps&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;softmax-求导&quot;&gt;Softmax 求导&lt;/h2&gt;
&lt;p&gt;由于 softmax 的良好性质，在用神经网络做分类任务时，通常直接将最后一层设置为 softmax, 这个时候就要考虑如何对 softmax 进行求导。神经网络输出 $\mathbf{z}$ 长度为 k ，那么要对这个 k 个输出进行求偏导。&lt;/p&gt;

\[\frac{\partial\sigma(\mathbf{z})}{\partial\mathbf{z}} = 
  \begin{bmatrix}
      \frac{\partial\sigma(z)_0}{\partial z_0} &amp;amp; \frac{\partial\sigma(z)_1}{\partial z_0} &amp;amp; ... &amp;amp; \frac{\partial\sigma(z)_N}{\partial z_0} \\
      \frac{\partial\sigma(z)_0}{\partial z_1} &amp;amp; \frac{\partial\sigma(z)_1}{\partial z_1} &amp;amp; ... &amp;amp; \frac{\partial\sigma(z)_N}{\partial z_1} \\
      ... \\
      \frac{\partial\sigma(z)_0}{\partial z_N} &amp;amp; \frac{\partial\sigma(z)_1}{\partial z_N} &amp;amp; ... &amp;amp; \frac{\partial\sigma(z)_N}{\partial z_N} \\
  \end{bmatrix}\]

&lt;p&gt;对于矩阵中的元素  \(\frac{\partial\sigma(z)_i}{\partial z_j}\) ， 如果  \(i \neq j\)  :&lt;/p&gt;

\[\begin{aligned} \frac{\partial\frac{e^{z_i}}{\sum_{k=1}^Ne^{z_k}} }{\partial z^j} &amp;amp; = \frac{0 - e^{z_i} e^{z_j}}{ (\sum_{k=1}^Ne^{z_k})^2 } \\
&amp;amp; = \frac{-e^{z_i}}{\sum_{k=1}^Ne^{z_k}} \times \frac{e^{z_j}}{\sum_{k=1}^Ne^{z_k}} \\
&amp;amp; = -p_i \times p_j\end{aligned}\]

&lt;p&gt;如果 i = j :&lt;/p&gt;

\[\begin{aligned}\frac{\partial\frac{e^{z_i}}{\sum_{k=1}^Ne^{z_k}} }{\partial z^i} &amp;amp;= \frac{ e^{z_i} }{ \sum_{k=1}^Ne^{z_k} } - \frac{ e^{2z_i} }{ (\sum_{k=1}^Ne^{z_k})^2 } \\
&amp;amp; = \frac{ e^{z_i} (\sum_{k=1}^Ne^k - e^{z_i}) }{ (\sum_{k=1}^Ne^{z_k})^2 } \\
&amp;amp; = p_i (1-p_i)
\end{aligned}\]

&lt;p&gt;求导矩阵可以改写为：&lt;/p&gt;

\[\frac{\partial\sigma(\mathbf{z})}{\partial\mathbf{z}} = 
  \begin{bmatrix}
      p_0(1-p_0) &amp;amp; -p_1 \times p_0 &amp;amp; ... &amp;amp; - p_N * p_0 \\
      -p_0 \times p_1 &amp;amp; p_1(1-p_1) &amp;amp; ... &amp;amp; - p_N * p_1 \\
      ... \\
      -p_0 \times p_N &amp;amp; -p_1 \times p_N &amp;amp; ... &amp;amp;  p_N(1-p_N) \\
\end{bmatrix}\]

&lt;h2 id=&quot;交叉熵&quot;&gt;交叉熵&lt;/h2&gt;</content><author><name></name></author><category term="machinelearning" /><category term="deeplearning" /><category term="math" /><summary type="html">Softmax函数 Softmax函数是在机器学习做分类预测中一个重要的工具函数。Softmax函数的数学定义如下： \[\sigma(z)_j = \frac{e^{z_j}}{\sum_{k=1}^Ne^{z_k}} \text{ for }j = 1, ..., N \text{ and } \mathbf{z} = (z_1, z_2, ..., z_k)\] 如果用神经网络做一个分类手写数字预测，那么神经网络的最后一层有10个输出，分别作为预测为 0 ~ 9 的概率。那么怎么判断预测结果到底是哪个数字呢？ 一个简单的方法是找到10个输出里最大的那个作为预测结果。 但是这10个输出是相互独立的，其和不等于1。所以一个更好的办法是将所有的输出的和缩放到1，然后看每个输出占的比重，将这个值作为预测概率，而 Softmax 函数恰好可以做到这一点。对于分类 i 的预测概率为 \(p_i =\sigma(z)_i\) Softmax 函数非常好实现，下面是用 numpy 实现的 Softmax def softmax(X): exps = np.exp(X) return exps / np.sum(exps) 在实现 Softmax 函数的时候，由于涉及到指数运算，在输出比较大的时候，非常容易造成结果溢出。 为了使得 softmax 函数在数值上更加稳定，我们可以先对 $\mathbf{z}$ 进行 normalization 。 Normalization 除了统计学上的标准分( \(\frac{\mathbf{X} - \mu}{\sigma}\) ) , 机器学习中还常用三种其他的方法： L1, L2 和 max L1: \(\frac{\mathbf{z}}{\sum_{i=1}^n{\vert z_i \vert }}\) L2: \(\frac{\mathbf{z}}{\sqrt{\sum_{i=1}^n{z_i^2}}}\) max: \(\frac{\mathbf{z}}{\max{\mathbf{z}}}\) 于是可以把上面的代码改写为 def stable_softmax(X): exps = np.exp(X - np.max(X)) return exps / np.sum(exps) Softmax 求导 由于 softmax 的良好性质，在用神经网络做分类任务时，通常直接将最后一层设置为 softmax, 这个时候就要考虑如何对 softmax 进行求导。神经网络输出 $\mathbf{z}$ 长度为 k ，那么要对这个 k 个输出进行求偏导。 \[\frac{\partial\sigma(\mathbf{z})}{\partial\mathbf{z}} = \begin{bmatrix} \frac{\partial\sigma(z)_0}{\partial z_0} &amp;amp; \frac{\partial\sigma(z)_1}{\partial z_0} &amp;amp; ... &amp;amp; \frac{\partial\sigma(z)_N}{\partial z_0} \\ \frac{\partial\sigma(z)_0}{\partial z_1} &amp;amp; \frac{\partial\sigma(z)_1}{\partial z_1} &amp;amp; ... &amp;amp; \frac{\partial\sigma(z)_N}{\partial z_1} \\ ... \\ \frac{\partial\sigma(z)_0}{\partial z_N} &amp;amp; \frac{\partial\sigma(z)_1}{\partial z_N} &amp;amp; ... &amp;amp; \frac{\partial\sigma(z)_N}{\partial z_N} \\ \end{bmatrix}\] 对于矩阵中的元素 \(\frac{\partial\sigma(z)_i}{\partial z_j}\) ， 如果 \(i \neq j\) : \[\begin{aligned} \frac{\partial\frac{e^{z_i}}{\sum_{k=1}^Ne^{z_k}} }{\partial z^j} &amp;amp; = \frac{0 - e^{z_i} e^{z_j}}{ (\sum_{k=1}^Ne^{z_k})^2 } \\ &amp;amp; = \frac{-e^{z_i}}{\sum_{k=1}^Ne^{z_k}} \times \frac{e^{z_j}}{\sum_{k=1}^Ne^{z_k}} \\ &amp;amp; = -p_i \times p_j\end{aligned}\] 如果 i = j : \[\begin{aligned}\frac{\partial\frac{e^{z_i}}{\sum_{k=1}^Ne^{z_k}} }{\partial z^i} &amp;amp;= \frac{ e^{z_i} }{ \sum_{k=1}^Ne^{z_k} } - \frac{ e^{2z_i} }{ (\sum_{k=1}^Ne^{z_k})^2 } \\ &amp;amp; = \frac{ e^{z_i} (\sum_{k=1}^Ne^k - e^{z_i}) }{ (\sum_{k=1}^Ne^{z_k})^2 } \\ &amp;amp; = p_i (1-p_i) \end{aligned}\] 求导矩阵可以改写为： \[\frac{\partial\sigma(\mathbf{z})}{\partial\mathbf{z}} = \begin{bmatrix} p_0(1-p_0) &amp;amp; -p_1 \times p_0 &amp;amp; ... &amp;amp; - p_N * p_0 \\ -p_0 \times p_1 &amp;amp; p_1(1-p_1) &amp;amp; ... &amp;amp; - p_N * p_1 \\ ... \\ -p_0 \times p_N &amp;amp; -p_1 \times p_N &amp;amp; ... &amp;amp; p_N(1-p_N) \\ \end{bmatrix}\] 交叉熵</summary></entry></feed>